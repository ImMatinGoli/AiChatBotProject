{% extends '_base.html' %}
{% load static %}

{% block title %}تنظیمات حساب کاربری{% endblock %}

{% block content %}
    <div class="container py-4">

        <div class="row mb-4">
            <div class="col-12">
                <h2 class="fw-bold">تنظیمات حساب</h2>
                <p class="text-secondary">اطلاعات شخصی، امنیت و وضعیت اشتراک خود را مدیریت کنید.</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="list-group list-group-flush" id="settings-tabs" role="tablist">
                        <a class="list-group-item list-group-item-action active p-3 d-flex align-items-center gap-2 border-0"
                           id="profile-tab" data-bs-toggle="list" href="#profile" role="tab">
                            <i class="bi bi-person-gear fs-5"></i> مشخصات فردی
                        </a>
                        <a class="list-group-item list-group-item-action p-3 d-flex align-items-center gap-2 border-0"
                           id="security-tab" data-bs-toggle="list" href="#security" role="tab">
                            <i class="bi bi-shield-lock fs-5"></i> امنیت و رمز عبور
                        </a>
                        <a class="list-group-item list-group-item-action p-3 d-flex align-items-center gap-2 border-0"
                           id="billing-tab" data-bs-toggle="list" href="#billing" role="tab">
                            <i class="bi bi-credit-card fs-5"></i> اشتراک و پرداخت
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-9">
                <div class="tab-content" id="nav-tabContent">

                    <div class="tab-pane fade show active" id="profile" role="tabpanel">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-body p-4">
                                <h5 class="fw-bold mb-4">اطلاعات شخصی</h5>

                                <!-- فرم اصلی -->
                                <form method="post" action="{% url 'profile_update' %}" enctype="multipart/form-data">
                                    {% csrf_token %}

                                    <!-- اینپوت مخفی برای تشخیص درخواست حذف عکس -->
                                    <input type="hidden" name="delete_photo" id="delete_photo_input" value="false">

                                    <!-- بخش مدیریت تصویر پروفایل -->
                                    <div class="d-flex align-items-center gap-3 mb-4">
                                        <div class="position-relative">
                                            <!-- نمایش عکس فعلی یا پیش‌فرض -->
                                            <img src="
                                                    {% if user.photo %}{{ user.photo.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}"
                                                 id="avatar-preview"
                                                 class="rounded-circle object-fit-cover border border-2 border-white shadow-sm"
                                                 style="width: 80px; height: 80px;"
                                                 alt="Profile">
                                        </div>

                                        <div class="d-flex gap-2">
                                            <!-- دکمه تغییر تصویر -->
                                            <div>
                                                <button type="button"
                                                        class="btn btn-outline-primary btn-sm rounded-pill"
                                                        onclick="document.getElementById('id_photo').click()">
                                                    <i class="bi bi-camera me-1"></i> تغییر تصویر
                                                </button>
                                                <!-- اینپوت فایل مخفی -->
                                                <input type="file" name="photo" id="id_photo" class="d-none"
                                                       accept="image/*" onchange="previewImage(this)">
                                            </div>

                                            <!-- دکمه حذف تصویر (قرمز) -->
                                            {% if user.photo and user.photo.name != 'users_photos/default.png' %}
                                                <button type="button"
                                                        class="btn btn-outline-danger btn-sm rounded-circle"
                                                        title="حذف تصویر و بازگشت به پیش‌فرض"
                                                        onclick="deleteProfileImage()">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>

                                    <div class="text-muted small mb-3 ms-2">فرمت‌های مجاز: JPG, PNG (حداکثر ۱ مگابایت)
                                    </div>

                                    <!-- فیلدهای متنی -->
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label small text-muted fw-bold">نام</label>
                                            <input type="text" name="first_name"
                                                   value="{{ user.first_name|default:'' }}"
                                                   class="form-control bg-light border-0 rounded-3">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small text-muted fw-bold">نام خانوادگی</label>
                                            <input type="text" name="last_name" value="{{ user.last_name|default:'' }}"
                                                   class="form-control bg-light border-0 rounded-3">
                                        </div>
                                        <div class="col-12">
                                            <label class="form-label small text-muted fw-bold">ایمیل (غیرقابل
                                                تغییر)</label>
                                            <input type="email" value="{{ user.email }}"
                                                   class="form-control bg-light border-0 rounded-3 text-secondary"
                                                   disabled>
                                        </div>

                                        <div class="col-12 text-end mt-4">
                                            <button type="submit" class="btn btn-primary px-4 rounded-3 fw-bold">
                                                <i class="bi bi-check-lg me-1"></i> ذخیره تغییرات
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- اسکریپت‌های مورد نیاز برای تغییر و حذف عکس -->
                    <script>
                        // تابع ۱: وقتی کاربر عکس جدید انتخاب می‌کنه
                        function previewImage(input) {
                            if (input.files && input.files[0]) {
                                var reader = new FileReader();
                                reader.onload = function (e) {
                                    // نمایش عکس انتخاب شده
                                    document.getElementById('avatar-preview').src = e.target.result;
                                    // چون عکس جدید انتخاب شده، پس نباید حذف بشه
                                    document.getElementById('delete_photo_input').value = 'false';
                                }
                                reader.readAsDataURL(input.files[0]);
                            }
                        }

                        // تابع ۲: وقتی کاربر دکمه سطل آشغال رو می‌زنه
                        function deleteProfileImage() {
                            // ۱. به بک‌ند میگیم که عکس رو پاک کنه
                            document.getElementById('delete_photo_input').value = 'true';

                            // ۲. فایلی که انتخاب کرده بود رو خالی می‌کنیم
                            document.getElementById('id_photo').value = '';

                            // ۳. یه عکس موقت (Placeholder) نشون میدیم که کاربر بفهمه پاک شده
                            // (بعد از ذخیره کردن، عکس اصلیِ دیفالت از سرور میاد)
                            var defaultAvatar = "https://ui-avatars.com/api/?name={{ user.username }}&background=random&color=fff&length=1";
                            document.getElementById('avatar-preview').src = defaultAvatar;
                        }
                    </script>

                    <script>
                        function previewImage(input) {
                            if (input.files && input.files[0]) {
                                var reader = new FileReader();
                                reader.onload = function (e) {
                                    document.getElementById('avatar-preview').src = e.target.result;
                                }
                                reader.readAsDataURL(input.files[0]);
                            }
                        }
                    </script>

                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div class="card border-0 shadow-sm rounded-4">
                            <div class="card-body p-4">
                                <h5 class="fw-bold mb-4">امنیت حساب</h5>

                                <div class="alert alert-warning border-0 d-flex align-items-center gap-3 rounded-3">
                                    <i class="bi bi-exclamation-triangle-fill fs-4 text-warning"></i>
                                    <div>
                                        <h6 class="m-0 fw-bold">رمز عبور خود را ایمن نگه دارید</h6>
                                        <small>توصیه می‌کنیم هر ۳ ماه یکبار رمز عبور خود را تغییر دهید.</small>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded-3 mt-4">
                                    <div>
                                        <h6 class="m-0 fw-bold">رمز عبور</h6>
                                        <small class="text-secondary">آخرین تغییر: ۲ ماه پیش</small>
                                    </div>
                                    <a href="{% url 'account_change_password' %}"
                                       class="btn btn-outline-dark rounded-3 btn-sm">تغییر رمز عبور</a>
                                </div>

                                <hr class="my-4 text-secondary opacity-25">

                                <h6 class="text-danger fw-bold mb-3">ناحیه خطر</h6>
                                <div class="d-flex align-items-center justify-content-between p-3 border border-danger border-opacity-25 bg-danger bg-opacity-10 rounded-3">
                                    <div>
                                        <h6 class="m-0 fw-bold text-danger">حذف حساب کاربری</h6>
                                        <small class="text-secondary">این عملیات غیرقابل بازگشت است.</small>
                                    </div>
                                    <button class="btn btn-danger btn-sm rounded-3">حذف اکانت</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="billing" role="tabpanel">
                        <div class="card border-0 shadow-sm rounded-4 mb-4">
                            <div class="card-body p-4 d-flex align-items-center justify-content-between flex-wrap gap-3">
                                <div>
                                    <small class="text-secondary fw-bold">اشتراک فعلی شما</small>
                                    <h3 class="fw-bold text-primary m-0">طرح رایگان</h3>
                                    <small class="text-muted">انقضا: نامحدود</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill">فعال</span>
                                </div>
                            </div>
                        </div>

                        <h5 class="fw-bold mb-3">ارتقای اشتراک</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm h-100 rounded-4" style="opacity: 0.7;">
                                    <div class="card-body p-4">
                                        <h5 class="fw-bold text-secondary">شروع</h5>
                                        <h2 class="fw-bold my-3">۰ <span class="fs-6 text-muted">تومان / ماهانه</span>
                                        </h2>
                                        <ul class="list-unstyled mb-4 small text-secondary">
                                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>دسترسی
                                                به GPT-3.5
                                            </li>
                                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>۵
                                                چت در روز
                                            </li>
                                            <li class="mb-2 text-muted"><i class="bi bi-x-circle me-2"></i>دسترسی به
                                                GPT-4
                                            </li>
                                        </ul>
                                        <button class="btn btn-secondary w-100 rounded-3 disabled">طرح فعلی</button>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="card border-primary shadow rounded-4 h-100 position-relative overflow-hidden">
                                    <div class="position-absolute top-0 end-0 bg-primary text-white small px-3 py-1 rounded-bottom-3"
                                         style="font-size: 0.75rem;">پیشنهاد ویژه
                                    </div>
                                    <div class="card-body p-4">
                                        <h5 class="fw-bold text-primary">حرفه‌ای (Pro)</h5>
                                        <h2 class="fw-bold my-3">۲۹۹ <span
                                                class="fs-6 text-muted">هزار تومان / ماهانه</span></h2>
                                        <ul class="list-unstyled mb-4 small">
                                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>دسترسی
                                                نامحدود به GPT-4
                                            </li>
                                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>سرعت
                                                پاسخگویی بالا
                                            </li>
                                            <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>پشتیبانی
                                                اولویت‌دار
                                            </li>
                                        </ul>
                                        <button class="btn btn-primary w-100 rounded-3 shadow fw-bold">ارتقا به
                                            حرفه‌ای
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <style>
        .list-group-item.active {
            background-color: #eef2ff !important;
            color: #4f46e5 !important;
            font-weight: bold;
            border-right: 4px solid #4f46e5 !important;
        }

        .list-group-item {
            color: #4b5563;
            transition: all 0.2s;
        }

        .list-group-item:hover:not(.active) {
            background-color: #f9fafb;
        }
    </style>
{% endblock %}